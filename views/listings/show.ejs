<% layout("/layouts/boilerplate") -%>

<% if (currUser) { %>
  <div class="text-center mt-3">
    <p>Welcome, <b><%= currUser.username %></b>!</p>
  </div>
<% } else { %>
  <div class="text-center mt-3">
    <p>Welcome, Guest!</p>
  </div>
<% } %>

<div class="row mt-3">
  <div class="col-8 offset-3">
    <h3><%= listing.title %></h3>
  </div>
  <%
    let imgUrl = listing.image && listing.image.url
      ? listing.image.url
      : "https://images.unsplash.com/photo-1625505826533-5c80aca7d157?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=60";
  %>
  <div class="card col-6 offset-3 show-card">
    <img src="<%= imgUrl %>" class="card-img-top show-img" alt="listing_image" />
    <div class="card-body">
      <p class="card-text">Owned by | <i><%= listing.owner.username %></i></p>
      <p class="card-text"><%= listing.description %></p>
      <p class="card-text">&#8377; <%= listing.price.toLocaleString("en-IN") %></p>
      <p class="card-text"><%= listing.location %></p>
      <p class="card-text"><%= listing.country %></p>
    </div>
  </div>
  <br />
  <div class="btns col-8 offset-3 mb-4">
    <% if (currUser && currUser._id && listing.owner && currUser._id.toString() === listing.owner._id.toString()) { %>
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark edit-btn me-3">Edit</a>
      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" style="display:inline;">
        <button type="submit" class="btn btn-danger delete-btn" onclick="return confirm('Are you sure you want to delete this listing?')">Delete</button>
      </form>
    <% } else { %>
      <button type="button" class="btn btn-outline-dark me-3 fake-btn" data-action="edit">Edit</button>
      <button type="button" class="btn btn-outline-dark fake-btn" data-action="delete">Delete</button>
    <% } %>
  </div>
  <% if (currUser) { %>
    <div class="col-8 offset-3">
      <hr>
      <h4>Leave a Review</h4>
      <p class="text-muted">You are logged in as <b><%= currUser.username %></b></p>
      <form method="POST" action="/listings/<%= listing._id %>/reviews" class="needs-validation" novalidate id="reviewForm">
        <div class="mb-3 mt-3">
          <label for="rating" class="form-label">Rating</label>
          <div class="star-rating">
            <input type="radio" id="star-5" name="review[rating]" value="5">
            <label for="star-5">★</label>
            <input type="radio" id="star-4" name="review[rating]" value="4">
            <label for="star-4">★</label>
            <input type="radio" id="star-3" name="review[rating]" value="3">
            <label for="star-3">★</label>
            <input type="radio" id="star-2" name="review[rating]" value="2">
            <label for="star-2">★</label>
            <input type="radio" id="star-1" name="review[rating]" value="1">
            <label for="star-1">★</label>
          </div>
        </div>
        <div class="mb-3">
          <label for="comment" class="form-label">Comments</label>
          <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control" required></textarea>
        </div>
        <button class="btn btn-outline-dark">Submit</button>
      </form>
    </div>
  <% } %>
  <% if(listing.reviews.length > 0) { %>
    <div class="col-12 mt-5">
      <p><b>All Reviews</b></p>
      <br>
      <div class="row g-4">
        <% for (let review of listing.reviews) { 
             let rate = review.rating && review.rating > 0 ? review.rating : 1; 
        %>
          <div class="col-md-6 col-lg-4 d-flex">
            <div class="card review-card h-100 w-100">
              <div class="card-body">
                <h5 class="card-title">
                  <% if (review.author && review.author.username) { %>
                    <%= review.author.username %>
                  <% } else { %>
                    Anonymous
                  <% } %>
                </h5>
                <div class="star-display mb-2">
                  <% for (let s = 1; s <= 5; s++) { %>
                    <span class="star"><%= s <= rate ? '★' : '☆' %></span>
                  <% } %>
                </div>
                <p class="card-text"><%= review.comment || "No comment provided." %></p>
                <% if (currUser && review.author && review.author._id.toString() === currUser._id.toString()) { %>
                  <form class="mt-3" method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                    <button type="submit" class="btn btn-sm btn-dark">Delete</button>
                  </form>
                <% } %>
              </div> 
            </div>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>
  
  <div class="col-8 offset-3 mb-3">
    <h3>Where you'll be</h3>
    <div id="map" style="height: 400px; width: 100%;"></div>
  </div>
</div>

<style>
.star-rating {
  display: flex;
  flex-direction: row-reverse;
  justify-content: flex-end;
  gap: 5px;
}
.star-rating input {
  display: none;
}
.star-rating label {
  font-size: 2rem;
  color: #ddd;
  cursor: pointer;
  transition: color 0.2s;
}
.star-rating input:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
  color: #ffc107;
}
.star-rating input:checked + label {
  color: #ffc107;
}
.star-display {
  font-size: 1.5rem;
}
.star-display .star {
  color: #ffc107;
}
.flash-pop {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #ff6b6b;
  color: white;
  padding: 15px 20px;
  border-radius: 5px;
  z-index: 1000;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  animation: slideIn 0.3s ease;
}
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
</style>

<script>
  const coordinates = <%= JSON.stringify(listing.geometry.coordinates) %>;
  document.querySelectorAll('.fake-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const action = btn.dataset.action;
      const msg = `Please <a href="/login" class="alert-link">login</a> to ${action} this listing.`;
      
      let oldAlert = document.querySelector('.alert-dismissible');
      if (oldAlert) oldAlert.remove();
      
      let alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
      alertDiv.style.zIndex = '1060';
      alertDiv.innerHTML = `
        ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 3000);
    });
  });
  const reviewForm = document.getElementById('reviewForm');
  if (reviewForm) {
    reviewForm.addEventListener('submit', (e) => {
      const selected = reviewForm.querySelector('input[name="review[rating]"]:checked');
      if (!selected) {
        const oneStar = reviewForm.querySelector('#star-1');
        if (oneStar) oneStar.checked = true;
      }
    });
  }
  let mapToken = "<%= process.env.MAP_TOKEN %>";
  mapboxgl.accessToken = mapToken;
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v12",
    center: coordinates,
    zoom: 7
  });
  const marker = new mapboxgl.Marker({color:'red'})
    .setLngLat(coordinates)
    .addTo(map);
</script>